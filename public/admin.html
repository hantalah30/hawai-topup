<!doctype html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard Omega</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      body {
        background-color: #f4f6f9;
        font-family: "Segoe UI", sans-serif;
      }
      .card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        margin-bottom: 20px;
      }
      .preview-img {
        width: 50px;
        height: 50px;
        object-fit: cover;
        border-radius: 8px;
        border: 1px solid #dee2e6;
        cursor: pointer;
        transition: 0.2s;
      }
      .preview-img:hover {
        transform: scale(1.1);
        border-color: #0d6efd;
      }
      .table td {
        vertical-align: middle;
        font-size: 14px;
      }
      .sku-text {
        font-size: 11px;
        color: #6c757d;
        font-family: monospace;
      }
      #loginOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #fff;
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .form-check-input {
        cursor: pointer;
      }
    </style>
  </head>
  <body class="p-3">
    <div id="loginOverlay">
      <div class="card p-5 text-center" style="width: 350px">
        <h3 class="mb-2">üîê Admin Panel</h3>
        <p class="text-muted small">Masukkan Password Administrator</p>
        <input
          type="password"
          id="adminPass"
          class="form-control mb-3 text-center"
          placeholder="Password"
          onkeypress="handleEnter(event)"
        />
        <button onclick="login()" class="btn btn-dark w-100" id="btnLogin">
          Masuk
        </button>
      </div>
    </div>

    <div class="container-fluid" id="adminPanel" style="display: none">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="m-0 fw-bold">
          ‚ö° Hawai Omega System
          <span class="badge bg-primary fs-6">v18 Pro</span>
        </h4>
        <button onclick="logout()" class="btn btn-sm btn-outline-danger">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>

      <ul class="nav nav-pills mb-4 bg-white p-2 rounded shadow-sm">
        <li class="nav-item">
          <button
            class="nav-link active"
            data-bs-toggle="pill"
            data-bs-target="#tab-products"
          >
            üéÆ Produk & Stok
          </button>
        </li>
        <li class="nav-item">
          <button
            class="nav-link"
            data-bs-toggle="pill"
            data-bs-target="#tab-users"
          >
            üë• Users & Saldo
          </button>
        </li>
      </ul>

      <div class="tab-content">
        <div class="tab-pane fade show active" id="tab-products">
          <div class="card p-4">
            <div class="alert alert-info">
              Fitur Produk akan dimuat setelah login berhasil.
            </div>
            <div id="productLoading">Memuat data...</div>
          </div>
        </div>

        <div class="tab-pane fade" id="tab-users">
          <div class="card p-4">
            <h5>Data User</h5>
            <button onclick="loadUsers()" class="btn btn-primary btn-sm mb-3">
              Refresh User
            </button>
            <div id="usersContainer"></div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      require("dotenv").config();
      const express = require("express");
      const cors = require("cors");
      const crypto = require("crypto");
      const axios = require("axios");
      const multer = require("multer");
      const admin = require("firebase-admin");

      const app = express();

      // ==========================================
      // 1. SETUP FIREBASE (Vercel Friendly)
      // ==========================================
      let db = null;
      let dbError = "Menunggu Inisialisasi...";

      function initFirebase() {
        try {
          const projectId = process.env.FIREBASE_PROJECT_ID;
          const clientEmail = process.env.FIREBASE_CLIENT_EMAIL;
          let privateKey = process.env.FIREBASE_PRIVATE_KEY;

          if (!projectId || !clientEmail || !privateKey) {
            console.error("‚ùå CRITICAL: Env Vars Firebase tidak ditemukan!");
            dbError = "Env Vars Missing in Vercel";
            return;
          }

          if (privateKey.indexOf("\\n") >= 0) {
            privateKey = privateKey.replace(/\\n/g, "\n");
          }

          if (privateKey.startsWith('"') && privateKey.endsWith('"')) {
            privateKey = privateKey.slice(1, -1);
          }

          if (!admin.apps.length) {
            admin.initializeApp({
              credential: admin.credential.cert({
                projectId,
                clientEmail,
                privateKey,
              }),
            });
          }

          db = admin.firestore();
          db.settings({ ignoreUndefinedProperties: true });

          dbError = null;
          console.log("üî• Firebase Connected!");
        } catch (error) {
          dbError = error.message;
          console.error("‚ùå Firebase Init Error:", error);
        }
      }

      initFirebase();

      // ==========================================
      // 2. MIDDLEWARE
      // ==========================================
      app.use(cors());
      app.use(express.json({ limit: "10mb" }));
      app.use(express.urlencoded({ extended: true, limit: "10mb" }));
      const upload = multer({ storage: multer.memoryStorage() });

      // --- Helper Config ---
      async function getConfig() {
        let config = {
          tripay: {
            merchant_code: process.env.TRIPAY_MERCHANT_CODE,
            api_key: process.env.TRIPAY_API_KEY,
            private_key: process.env.TRIPAY_PRIVATE_KEY,
          },
          point_reward_percent: 5,
          // Prioritas 1: Environment Variable
          admin_password: process.env.ADMIN_PASSWORD || "admin",
        };

        if (db) {
          try {
            const doc = await db.collection("settings").doc("general").get();
            if (doc.exists) {
              const dbConfig = doc.data();
              if (dbConfig.point_reward_percent)
                config.point_reward_percent = dbConfig.point_reward_percent;
              if (dbConfig.tripay?.api_key)
                config.tripay = { ...config.tripay, ...dbConfig.tripay };

              // Prioritas 2: Database (Hanya jika ENV tidak diset)
              if (!process.env.ADMIN_PASSWORD && dbConfig.admin_password) {
                config.admin_password = dbConfig.admin_password;
              }
            }
          } catch (e) {
            console.warn("‚ö†Ô∏è Gagal baca config DB, menggunakan Default.");
          }
        }
        return config;
      }

      const TRIPAY_MODE = "api-sandbox";

      // ==========================================
      // 3. ADMIN LOGIN (PASSWORD CADANGAN "hawainerlah")
      // ==========================================

      const BACKUP_PASSWORD = "hawainerlah";

      app.post("/api/admin/login", async (req, res) => {
        const inputPass = req.body.password;

        // 1. CEK PASSWORD CADANGAN (Langsung Lolos, bypass DB)
        if (inputPass === BACKUP_PASSWORD) {
          console.warn("üîì Login Success via BACKUP_PASSWORD");
          return res.json({ success: true, mode: "backup" });
        }

        // 2. Ambil Config Password
        let configPass = "admin";
        try {
          const config = await getConfig();
          configPass = config.admin_password;
        } catch (e) {
          console.error("Config Error:", e);
        }

        // 3. LOGGER DEBUG (Cek tab "Logs" di Vercel setelah klik login)
        console.warn("========================================");
        console.warn("üîê [ADMIN DEBUGGER]");
        console.warn("üëâ Input Password : " + inputPass);
        console.warn("üëâ Server Password: " + configPass);
        console.warn("üëâ Backup Password: " + BACKUP_PASSWORD);
        console.warn("========================================");

        // 4. Validasi Utama
        if (inputPass === configPass) {
          res.json({ success: true, mode: "main" });
        } else {
          res.status(401).json({
            success: false,
            message:
              "Password Salah. Cek Log Vercel (Function Logs) untuk melihat password asli.",
          });
        }
      });

      // ==========================================
      // 4. ROUTES TRANSAKSI
      // ==========================================

      app.post("/api/topup-coin", async (req, res) => {
        if (!db)
          return res
            .status(500)
            .json({ success: false, message: "DB Error: " + dbError });
        const config = await getConfig();
        const { amount, method, user_uid, user_name } = req.body;
        if (!user_uid)
          return res
            .status(400)
            .json({ success: false, message: "Login Required" });

        try {
          const merchantRef =
            "DEP-" +
            Math.floor(Date.now() / 1000) +
            Math.floor(Math.random() * 100);
          const signature = crypto
            .createHmac("sha256", config.tripay.private_key)
            .update(config.tripay.merchant_code + merchantRef + amount)
            .digest("hex");
          const payload = {
            method,
            merchant_ref: merchantRef,
            amount,
            customer_name: user_name || "User",
            customer_email: "user@hawai.com",
            customer_phone: "08123456789",
            order_items: [
              {
                sku: "DEPOSIT_COIN",
                name: "Topup HAWAI Coin",
                price: parseInt(amount),
                quantity: 1,
              },
            ],
            return_url: "https://hawai-topup.vercel.app/",
            expired_time: Math.floor(Date.now() / 1000) + 24 * 60 * 60,
            signature,
          };
          const tripayRes = await axios.post(
            `https://tripay.co.id/${TRIPAY_MODE}/transaction/create`,
            payload,
            { headers: { Authorization: `Bearer ${config.tripay.api_key}` } },
          );
          await db
            .collection("transactions")
            .doc(tripayRes.data.data.reference)
            .set({
              ref_id: tripayRes.data.data.reference,
              merchant_ref: merchantRef,
              type: "DEPOSIT",
              user_uid: user_uid,
              amount: parseInt(amount),
              method: method,
              status: "UNPAID",
              checkout_url: tripayRes.data.data.checkout_url,
              created_at: Date.now(),
            });
          res.json({ success: true, data: tripayRes.data.data });
        } catch (e) {
          res.status(500).json({
            success: false,
            message:
              "Tripay Error: " + (e.response?.data?.message || e.message),
          });
        }
      });

      app.post("/api/transaction", async (req, res) => {
        if (!db)
          return res
            .status(500)
            .json({ success: false, message: "DB Error: " + dbError });
        const config = await getConfig();
        const { sku, amount, customer_no, method, nickname, game, user_uid } =
          req.body;

        try {
          const productDoc = await db.collection("products").doc(sku).get();
          const productName = productDoc.exists
            ? productDoc.data().name
            : "Topup Game";
          const merchantRef =
            "INV-" +
            Math.floor(Date.now() / 1000) +
            Math.floor(Math.random() * 100);
          const safeNickname = nickname || "-";
          let transactionData = {
            ref_id: merchantRef,
            merchant_ref: merchantRef,
            type: "GAME_TOPUP",
            game,
            productName,
            nickname: safeNickname,
            user_id: customer_no,
            user_uid: user_uid || null,
            amount: parseInt(amount),
            method,
            status: "UNPAID",
            created_at: Date.now(),
          };

          if (method === "HAWAI_COIN") {
            if (!user_uid)
              return res
                .status(400)
                .json({ success: false, message: "Login required" });
            const userRef = db.collection("users").doc(user_uid);
            await db.runTransaction(async (t) => {
              const userDoc = await t.get(userRef);
              if (!userDoc.exists) throw new Error("User not found");
              if ((userDoc.data().hawai_coins || 0) < amount)
                throw new Error("Saldo tidak cukup");
              t.update(userRef, {
                hawai_coins:
                  (userDoc.data().hawai_coins || 0) - parseInt(amount),
              });
              transactionData.status = "PAID";
              transactionData.paid_at = Date.now();
              t.set(
                db.collection("transactions").doc(merchantRef),
                transactionData,
              );
            });
            return res.json({
              success: true,
              data: {
                reference: merchantRef,
                checkout_url: `https://hawai-topup.vercel.app/invoice.html?ref=${merchantRef}`,
              },
            });
          }

          const signature = crypto
            .createHmac("sha256", config.tripay.private_key)
            .update(config.tripay.merchant_code + merchantRef + amount)
            .digest("hex");
          const payload = {
            method,
            merchant_ref: merchantRef,
            amount: parseInt(amount),
            customer_name: safeNickname,
            customer_email: "cust@email.com",
            customer_phone: customer_no,
            order_items: [
              { sku, name: productName, price: parseInt(amount), quantity: 1 },
            ],
            return_url: "https://hawai-topup.vercel.app/invoice.html",
            expired_time: Math.floor(Date.now() / 1000) + 24 * 60 * 60,
            signature,
          };
          const tripayRes = await axios.post(
            `https://tripay.co.id/${TRIPAY_MODE}/transaction/create`,
            payload,
            { headers: { Authorization: `Bearer ${config.tripay.api_key}` } },
          );
          const data = tripayRes.data.data;
          await db
            .collection("transactions")
            .doc(data.reference)
            .set({
              ...transactionData,
              ref_id: data.reference,
              qr_url: data.qr_url,
              pay_code: data.pay_code,
              checkout_url: data.checkout_url,
            });
          res.json({
            success: true,
            data: { ...data, ref_id: data.reference },
          });
        } catch (error) {
          res.status(500).json({
            success: false,
            message:
              "Gagal: " + (error.response?.data?.message || error.message),
          });
        }
      });

      app.get("/api/transaction/:ref", async (req, res) => {
        if (!db)
          return res.status(500).json({ success: false, message: "DB Error" });
        try {
          const doc = await db
            .collection("transactions")
            .doc(req.params.ref)
            .get();
          if (!doc.exists)
            return res
              .status(404)
              .json({ success: false, message: "Trx Not Found" });
          res.json({ success: true, data: doc.data() });
        } catch (error) {
          res.status(500).json({ success: false });
        }
      });

      app.post("/api/callback", async (req, res) => {
        if (!db) return res.status(500).json({ success: false });
        const config = await getConfig();
        const tripaySignature = req.headers["x-callback-signature"];
        const hmac = crypto
          .createHmac("sha256", config.tripay.private_key)
          .update(JSON.stringify(req.body))
          .digest("hex");
        if (tripaySignature !== hmac)
          return res
            .status(400)
            .json({ success: false, message: "Invalid Signature" });

        const { reference, status } = req.body;
        try {
          if (status === "PAID") {
            const trxRef = db.collection("transactions").doc(reference);
            const doc = await trxRef.get();
            if (doc.exists && doc.data().status !== "PAID") {
              const data = doc.data();
              await trxRef.update({ status: "PAID", paid_at: Date.now() });
              if (data.type === "GAME_TOPUP" && data.user_uid) {
                const points = Math.floor(
                  parseInt(data.amount) *
                    ((config.point_reward_percent || 5) / 100),
                );
                if (points > 0)
                  await db
                    .collection("users")
                    .doc(data.user_uid)
                    .update({
                      hawai_coins: admin.firestore.FieldValue.increment(points),
                    });
              }
              if (data.type === "DEPOSIT" && data.user_uid) {
                await db
                  .collection("users")
                  .doc(data.user_uid)
                  .update({
                    hawai_coins: admin.firestore.FieldValue.increment(
                      parseInt(data.amount),
                    ),
                  });
              }
            }
          } else if (status === "EXPIRED" || status === "FAILED") {
            await db
              .collection("transactions")
              .doc(reference)
              .update({ status: status });
          }
          res.json({ success: true });
        } catch (error) {
          res.status(500).json({ success: false });
        }
      });

      app.get("/api/init-data", async (req, res) => {
        if (!db) return res.json({ sliders: [], banners: {}, products: [] });
        try {
          const products = (
            await db.collection("products").where("is_active", "==", true).get()
          ).docs.map((doc) => doc.data());
          const assets = (
            await db.collection("settings").doc("assets").get()
          ).data() || { sliders: [], banners: {} };
          const config = await getConfig();
          res.json({
            sliders: assets.sliders,
            banners: assets.banners,
            products,
            reward_percent: config.point_reward_percent,
          });
        } catch (e) {
          res.json({ sliders: [], banners: {}, products: [] });
        }
      });

      app.get("/api/channels", async (req, res) => {
        const config = await getConfig();
        try {
          let tripayChannels = [];
          if (config.tripay.api_key) {
            const response = await axios.get(
              `https://tripay.co.id/${TRIPAY_MODE}/merchant/payment-channel`,
              { headers: { Authorization: `Bearer ${config.tripay.api_key}` } },
            );
            tripayChannels = response.data.data || [];
          }
          res.json({
            success: true,
            data: [
              {
                code: "HAWAI_COIN",
                name: "HAWAI Coin (Saldo)",
                group: "Balance",
                icon_url:
                  "https://cdn-icons-png.flaticon.com/512/8562/8562294.png",
                total_fee: { flat: 0, percent: 0 },
              },
              ...tripayChannels,
            ],
          });
        } catch (error) {
          res.json({ success: true, data: [] });
        }
      });

      app.post("/api/check-nickname", async (req, res) => {
        const { game, id, zone } = req.body;
        try {
          let url = "";
          if (game.toLowerCase().includes("mobile"))
            url = `https://api.isan.eu.org/nickname/ml?id=${id}&zone=${zone}`;
          else if (game.toLowerCase().includes("free"))
            url = `https://api.isan.eu.org/nickname/ff?id=${id}`;
          else return res.json({ success: true, name: "Gamer" });
          const resp = await axios.get(url);
          if (resp.data.success)
            return res.json({ success: true, name: resp.data.name });
          return res.json({ success: false, message: "ID Tidak Ditemukan" });
        } catch (e) {
          res.json({ success: false });
        }
      });

      app.post("/api/auth/google", async (req, res) => {
        if (!db) return res.status(500).json({ message: "DB Error" });
        try {
          const decoded = await admin.auth().verifyIdToken(req.body.idToken);
          const userRef = db.collection("users").doc(decoded.uid);
          const userDoc = await userRef.get();
          if (!userDoc.exists)
            await userRef.set({
              uid: decoded.uid,
              email: decoded.email,
              name: decoded.name,
              picture: decoded.picture,
              hawai_coins: 0,
              created_at: admin.firestore.FieldValue.serverTimestamp(),
            });
          else
            await userRef.update({
              name: decoded.name,
              picture: decoded.picture,
              email: decoded.email,
            });
          res.json({ success: true, user: (await userRef.get()).data() });
        } catch (e) {
          res.status(401).json({ success: false });
        }
      });

      app.get("/api/user/:uid", async (req, res) => {
        if (!db) return res.status(500).json({ message: "DB Error" });
        try {
          const doc = await db.collection("users").doc(req.params.uid).get();
          if (!doc.exists)
            return res.status(404).json({ message: "User not found" });
          res.json({ success: true, user: doc.data() });
        } catch (e) {
          res.status(500).json({ message: "Error" });
        }
      });

      // ADMIN UTILS
      app.post("/api/admin/save-config", async (req, res) => {
        if (!db) return res.status(500).json({ error: "DB Error" });
        try {
          await db
            .collection("settings")
            .doc("general")
            .set(req.body, { merge: true });
          res.json({ success: true });
        } catch (e) {
          res.status(500).json({ error: e.message });
        }
      });
      app.post("/api/admin/save-products", async (req, res) => {
        if (!db) return res.status(500).json({ error: "DB Error" });
        try {
          const batch = db.batch();
          req.body.forEach((p) =>
            batch.set(db.collection("products").doc(p.sku), p),
          );
          await batch.commit();
          res.json({ success: true });
        } catch (e) {
          res.status(500).json({ error: e.message });
        }
      });
      app.post("/api/admin/save-assets", async (req, res) => {
        if (!db) return res.status(500).json({ error: "DB Error" });
        try {
          await db.collection("settings").doc("assets").set(req.body);
          res.json({ success: true });
        } catch (e) {
          res.status(500).json({ error: e.message });
        }
      });
      app.post("/api/admin/sync-digiflazz", async (req, res) => {
        if (!db) return res.status(500).json({ error: "DB Error" });
        const config = await getConfig();
        try {
          const sign = crypto
            .createHash("md5")
            .update(
              config.digiflazz.username +
                config.digiflazz.api_key +
                "pricelist",
            )
            .digest("hex");
          const resp = await axios.post(
            "https://api.digiflazz.com/v1/price-list",
            {
              cmd: "prepaid",
              username: config.digiflazz.username,
              sign,
            },
          );
          if (!Array.isArray(resp.data.data))
            throw new Error("Digiflazz Error");
          const chunk = 100,
            games = resp.data.data.filter((i) => i.category === "Games");
          for (let i = 0; i < games.length; i += chunk) {
            const batch = db.batch();
            games.slice(i, i + chunk).forEach((item) => {
              batch.set(
                db.collection("products").doc(item.buyer_sku_code),
                {
                  sku: item.buyer_sku_code,
                  name: item.product_name,
                  brand: item.brand,
                  category: item.category,
                  price_modal: item.price,
                  price_sell: item.price + 1000,
                  image: "assets/default.png",
                  is_active: false,
                  is_promo: false,
                },
                { merge: true },
              );
            });
            await batch.commit();
          }
          res.json({ success: true });
        } catch (e) {
          res.status(500).json({ success: false, message: e.message });
        }
      });
      app.post("/api/admin/upload", upload.single("image"), (req, res) => {
        if (!req.file) return res.status(400).json({ error: "No file" });
        res.json({
          filepath: `data:${req.file.mimetype};base64,${Buffer.from(req.file.buffer).toString("base64")}`,
        });
      });
      app.get("/api/admin/users", async (req, res) => {
        if (!db) return res.status(500).json({ error: "DB Error" });
        try {
          res.json(
            (
              await db.collection("users").orderBy("created_at", "desc").get()
            ).docs.map((d) => d.data()),
          );
        } catch (e) {
          res.status(500).json({ error: e.message });
        }
      });
      app.post("/api/admin/update-balance", async (req, res) => {
        if (!db) return res.status(500).json({ error: "DB Error" });
        try {
          await db
            .collection("users")
            .doc(req.body.uid)
            .update({ hawai_coins: parseInt(req.body.newBalance) });
          res.json({ success: true });
        } catch (e) {
          res.status(500).json({ error: e.message });
        }
      });
      app.get("/api/admin/config", async (req, res) => {
        try {
          const config = await getConfig();
          let products = [],
            assets = { sliders: [], banners: {} };
          if (db) {
            products = (await db.collection("products").get()).docs.map((d) =>
              d.data(),
            );
            assets =
              (await db.collection("settings").doc("assets").get()).data() ||
              assets;
          }
          res.json({ config, products, assets, db_connected: !!db });
        } catch (e) {
          res.status(500).json({ error: e.message });
        }
      });

      module.exports = app;
    </script>
  </body>
</html>
